<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0f">
<title>主観時間増幅診断</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--bg2:#111119;--bg3:#1a1a26;
  --gold:#c9a84c;--gold-dim:rgba(201,168,76,0.2);--gold-glow:rgba(201,168,76,0.12);
  --text:#d8d4cc;--dim:#6b6760;--red:#b54a4a;--green:#5a9a6a;
  --serif:'Noto Serif JP',serif;--sans:'Zen Kaku Gothic New',sans-serif;
  --radius:10px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--sans);
  overflow-x:hidden;-webkit-tap-highlight-color:transparent;font-size:15px;line-height:1.7}

.scr{display:none;flex-direction:column;align-items:center;min-height:100dvh;
  padding:3rem 1.5rem 2rem;opacity:0}
.scr.on{display:flex;animation:fadeUp .6s ease forwards}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

#prog{position:fixed;top:0;left:0;height:2px;background:linear-gradient(90deg,var(--gold-dim),var(--gold));
  transition:width .5s ease;z-index:999}

.title-lg{font-family:var(--serif);font-size:1.8rem;letter-spacing:.15em;text-align:center;
  color:var(--text);margin-bottom:.3rem}
.title-sub{font-size:.8rem;color:var(--dim);letter-spacing:.2em;text-align:center;margin-bottom:2rem}
.narr{font-family:var(--serif);font-size:1rem;line-height:2;text-align:center;
  color:var(--text);max-width:340px;margin-bottom:2rem;letter-spacing:.03em}
.narr-dim{color:var(--dim);font-size:.85rem}
.scene-label{font-size:.7rem;color:var(--dim);letter-spacing:.25em;margin-bottom:1.2rem}

.btn{background:transparent;border:1px solid rgba(201,168,76,.25);border-radius:50px;
  color:var(--gold);font-family:var(--serif);font-size:.9rem;padding:.85rem 2.4rem;
  cursor:pointer;transition:all .3s;letter-spacing:.12em;margin-top:1rem}
.btn:active{background:var(--gold-dim);transform:scale(.97)}
.btn-sm{font-size:.8rem;padding:.6rem 1.6rem;margin-top:.5rem}

.q-block{width:100%;max-width:380px;margin-bottom:2rem}
.q-text{font-family:var(--serif);font-size:.95rem;line-height:1.9;margin-bottom:1rem;
  padding-left:.5rem;border-left:2px solid var(--gold-dim)}
.q-opts{display:flex;gap:.5rem}
.q-opt{flex:1;background:var(--bg2);border:1px solid rgba(201,168,76,.08);border-radius:var(--radius);
  color:var(--dim);font-size:.82rem;padding:.7rem .4rem;text-align:center;cursor:pointer;
  transition:all .25s;font-family:var(--sans)}
.q-opt:active,.q-opt.sel{border-color:var(--gold);color:var(--gold);background:var(--gold-glow)}
.q-footer{font-size:.7rem;color:var(--dim);text-align:center;margin-top:1.5rem;letter-spacing:.1em}

.mg-area{width:100%;max-width:360px;min-height:220px;background:var(--bg2);
  border:1px solid rgba(201,168,76,.06);border-radius:var(--radius);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:1.5rem;margin-bottom:1.5rem;position:relative;overflow:hidden}
.mg-timer{position:absolute;top:10px;right:14px;font-size:.7rem;color:var(--dim);font-variant-numeric:tabular-nums}
.mg-inst{font-size:.85rem;color:var(--dim);text-align:center;margin-bottom:1rem}

.tap-circle{width:130px;height:130px;border-radius:50%;border:2px solid var(--gold-dim);
  display:flex;align-items:center;justify-content:center;font-family:var(--serif);
  font-size:1.1rem;color:var(--gold);cursor:pointer;transition:all .2s;user-select:none}
.tap-circle:active{background:var(--gold-dim);transform:scale(.95)}
.tap-circle.running{border-color:var(--gold);animation:pulse 1s ease infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 var(--gold-dim)}50%{box-shadow:0 0 0 14px transparent}}

.snap-pair{display:flex;gap:.6rem;width:100%}
.snap-card{flex:1;background:var(--bg3);border:1px solid rgba(201,168,76,.06);border-radius:var(--radius);
  padding:.8rem .6rem;text-align:center;font-size:.8rem;cursor:pointer;transition:all .2s;
  color:var(--text);min-height:70px;display:flex;align-items:center;justify-content:center;
  line-height:1.5}
.snap-card:active{border-color:var(--gold);background:var(--gold-glow)}
.snap-round{font-size:.7rem;color:var(--dim);margin-bottom:.6rem}
.snap-timer-bar{width:100%;height:3px;background:var(--bg3);border-radius:2px;margin-top:.8rem;overflow:hidden}
.snap-timer-fill{height:100%;background:var(--gold);transition:width linear}

.num-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;width:100%;max-width:260px}
.num-cell{aspect-ratio:1;background:var(--bg3);border:1px solid rgba(201,168,76,.08);border-radius:8px;
  display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-family:var(--serif);
  color:var(--text);cursor:pointer;transition:all .15s;user-select:none}
.num-cell:active{transform:scale(.92)}
.num-cell.done{background:var(--gold-glow);color:var(--gold);border-color:var(--gold);pointer-events:none}
.num-cell.wrong{animation:shake .3s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}

.resume-btns{display:flex;gap:.8rem;margin-top:1rem}
.resume-btn{background:var(--bg2);border:1px solid rgba(201,168,76,.12);border-radius:var(--radius);
  color:var(--text);font-size:.85rem;padding:.7rem 1.5rem;cursor:pointer;transition:all .2s;
  font-family:var(--sans)}
.resume-btn:active{border-color:var(--gold);color:var(--gold)}

.res-type{font-family:var(--serif);font-size:1.6rem;letter-spacing:.15em;text-align:center;
  color:var(--gold);margin-bottom:.3rem;text-shadow:0 0 30px var(--gold-glow)}
.res-title{font-size:.85rem;color:var(--dim);letter-spacing:.2em;text-align:center;margin-bottom:.3rem}
.res-oneliner{font-family:var(--serif);font-size:.9rem;color:var(--text);text-align:center;
  margin-bottom:2rem;opacity:.8}
.res-card{width:100%;max-width:380px;background:var(--bg2);border:1px solid rgba(201,168,76,.08);
  border-radius:var(--radius);padding:1.3rem;margin-bottom:1rem}
.res-card-label{font-size:.7rem;color:var(--gold);letter-spacing:.2em;margin-bottom:.6rem}
.res-card-body{font-family:var(--serif);font-size:.92rem;line-height:1.9}
.res-card-body li{list-style:none;margin-bottom:.8rem;padding-left:1.2rem;position:relative}
.res-card-body li::before{content:'▸';position:absolute;left:0;color:var(--gold)}
.res-taboo{border-color:rgba(181,74,74,.15)}
.res-taboo .res-card-label{color:var(--red)}
.res-footer{margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(201,168,76,.06);
  width:100%;max-width:380px}
.res-footer p{font-family:var(--serif);font-size:.85rem;color:var(--dim);text-align:center;line-height:2}
.res-actions{display:flex;flex-direction:column;gap:.6rem;align-items:center;margin-top:1.5rem}

.bar-chart{width:100%;max-width:380px;margin-bottom:1.5rem}
.bar-row{display:flex;align-items:center;gap:.6rem;margin-bottom:.5rem}
.bar-label{font-size:.72rem;color:var(--dim);width:70px;text-align:right;flex-shrink:0}
.bar-track{flex:1;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;transition:width .8s ease .3s}
.bar-fill.top{background:var(--gold)}
.bar-fill.normal{background:rgba(201,168,76,.3)}

.amb{position:fixed;pointer-events:none;z-index:-1}
.amb1{top:-20%;left:-30%;width:80%;height:50%;background:radial-gradient(ellipse,rgba(201,168,76,.03) 0%,transparent 70%)}
.amb2{bottom:-15%;right:-20%;width:60%;height:40%;background:radial-gradient(ellipse,rgba(201,168,76,.02) 0%,transparent 70%)}

.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--bg3);border:1px solid var(--gold-dim);border-radius:var(--radius);
  padding:.6rem 1.5rem;font-size:.8rem;color:var(--gold);opacity:0;transition:all .3s;z-index:1000;
  white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

.spacer{flex:1}
</style>
</head>
<body>

<div class="amb amb1"></div>
<div class="amb amb2"></div>
<div id="prog" style="width:0%"></div>
<div id="toast" class="toast">コピーしました</div>

<!-- 1. START -->
<div class="scr on" id="s-start">
  <div class="spacer"></div>
  <div class="title-lg">主観時間増幅診断</div>
  <div class="title-sub">世界王プロトコル v1.0</div>
  <p class="narr">時間が足りないのは、<br>努力不足じゃない。<br>設計の問題だ。</p>
  <button class="btn" onclick="go('s-intro')">診断を始める</button>
  <div class="spacer"></div>
</div>

<!-- 2. INTRO -->
<div class="scr" id="s-intro">
  <div class="spacer"></div>
  <p class="narr">ようこそ、世界王領へ。<br><br>ここでは"怠け"は罪じゃない。<br>ただ、設計が古いだけ。<br><br>今から、あなたの時間が縮む原因を<br>「性格」ではなく<br>「構造」として見つける。</p>
  <button class="btn" onclick="go('s-q12')">構造を測る</button>
  <div class="spacer"></div>
</div>

<!-- 3. Q1-Q2 -->
<div class="scr" id="s-q12">
  <div class="scene-label">QUESTION 1 – 2</div>
  <div class="q-block">
    <div class="q-text">作業中、気づくと呼吸が浅くなって、視野が狭い感じになっている</div>
    <div class="q-opts">
      <div class="q-opt" onclick="ans(1,0,this)">ほぼない</div>
      <div class="q-opt" onclick="ans(1,1,this)">たまに</div>
      <div class="q-opt" onclick="ans(1,2,this)">よくある</div>
    </div>
  </div>
  <div class="q-block">
    <div class="q-text">予定を限界まで詰めがちで、突発が来ると一気に崩れる</div>
    <div class="q-opts">
      <div class="q-opt" onclick="ans(2,0,this)">ほぼない</div>
      <div class="q-opt" onclick="ans(2,1,this)">たまに</div>
      <div class="q-opt" onclick="ans(2,2,this)">よくある</div>
    </div>
  </div>
  <div class="q-footer">正解はない。今の状態を拾うだけ。</div>
  <button class="btn disabled" id="btn-q12" onclick="go('s-mg1')">次へ</button>
</div>

<!-- 4. MG1: 5秒タップ -->
<div class="scr" id="s-mg1">
  <div class="scene-label">RITUAL 1</div>
  <p class="narr">小さな儀式をする。<br>「5秒」を、体で思い出して。</p>
  <div class="mg-area">
    <div class="mg-inst" id="mg1-inst">タップで開始 → 5秒だと思ったら再びタップ</div>
    <div class="tap-circle" id="mg1-circle" onclick="mg1Tap()">START</div>
  </div>
</div>

<div class="scr" id="s-mg1done">
  <div class="spacer"></div>
  <p class="narr">いい。<br>今の反応は記録した。<br>先へ進もう。</p>
  <button class="btn" onclick="go('s-q34')">次へ</button>
  <div class="spacer"></div>
</div>

<!-- 5. Q3-Q4 -->
<div class="scr" id="s-q34">
  <div class="scene-label">QUESTION 3 – 4</div>
  <div class="q-block">
    <div class="q-text">やるべきことを"自然にやってしまう仕組み"が少ない（開始が重い）</div>
    <div class="q-opts">
      <div class="q-opt" onclick="ans(3,0,this)">ほぼない</div>
      <div class="q-opt" onclick="ans(3,1,this)">たまに</div>
      <div class="q-opt" onclick="ans(3,2,this)">よくある</div>
    </div>
  </div>
  <div class="q-block">
    <div class="q-text">スマホ・通知・お菓子・人の視線など、集中を奪うものが近い</div>
    <div class="q-opts">
      <div class="q-opt" onclick="ans(4,0,this)">ほぼない</div>
      <div class="q-opt" onclick="ans(4,1,this)">たまに</div>
      <div class="q-opt" onclick="ans(4,2,this)">よくある</div>
    </div>
  </div>
  <div class="q-footer">正解はない。今の状態を拾うだけ。</div>
  <button class="btn disabled" id="btn-q34" onclick="go('s-mg2')">次へ</button>
</div>

<!-- 6. MG2: 瞬間優先度 -->
<div class="scr" id="s-mg2">
  <div class="scene-label">RITUAL 2</div>
  <p class="narr">次は"王の決断力"を見る。<br>重要か、安心か。<br>迷ってもいい。反射を拾うだけだ。</p>
  <div class="mg-area" id="mg2-area">
    <div class="snap-round" id="mg2-round"></div>
    <div class="mg-inst" id="mg2-inst">0.7秒以内に選べ</div>
    <div class="snap-pair" id="mg2-pair" style="display:none"></div>
    <div class="snap-timer-bar" id="mg2-bar-wrap" style="display:none">
      <div class="snap-timer-fill" id="mg2-bar"></div>
    </div>
    <button class="btn btn-sm" id="mg2-startbtn" onclick="mg2Start()">始める</button>
  </div>
</div>

<div class="scr" id="s-mg2done">
  <div class="spacer"></div>
  <p class="narr">なるほど。<br>あなたの手は、<br>先にどこへ伸びた。</p>
  <button class="btn" onclick="go('s-q56')">次へ</button>
  <div class="spacer"></div>
</div>

<!-- 7. Q5-Q6 -->
<div class="scr" id="s-q56">
  <div class="scene-label">QUESTION 5 – 6</div>
  <div class="q-block">
    <div class="q-text">重要なことに入る前に、細かい作業を先にやって安心しがち</div>
    <div class="q-opts">
      <div class="q-opt" onclick="ans(5,0,this)">ほぼない</div>
      <div class="q-opt" onclick="ans(5,1,this)">たまに</div>
      <div class="q-opt" onclick="ans(5,2,this)">よくある</div>
    </div>
  </div>
  <div class="q-block">
    <div class="q-text">同時に複数を進めようとして、切り替えで消耗する</div>
    <div class="q-opts">
      <div class="q-opt" onclick="ans(6,0,this)">ほぼない</div>
      <div class="q-opt" onclick="ans(6,1,this)">たまに</div>
      <div class="q-opt" onclick="ans(6,2,this)">よくある</div>
    </div>
  </div>
  <div class="q-footer">正解はない。今の状態を拾うだけ。</div>
  <button class="btn disabled" id="btn-q56" onclick="go('s-mg3')">次へ</button>
</div>

<!-- 8. MG3: 強制中断 -->
<div class="scr" id="s-mg3">
  <div class="scene-label">RITUAL 3</div>
  <p class="narr">最後に"未完の火種"を残す。<br>途中で終わっても、<br>あなたが壊れていないかを見る。</p>
  <div class="mg-area" id="mg3-area">
    <div class="mg-timer" id="mg3-timer">8.0s</div>
    <div class="mg-inst">1 から順番にタップせよ</div>
    <div class="num-grid" id="mg3-grid"></div>
    <button class="btn btn-sm" id="mg3-startbtn" onclick="mg3Start()">始める</button>
  </div>
</div>

<div class="scr" id="s-mg3stop">
  <div class="spacer"></div>
  <p class="narr">ここで止める。<br>キリが悪いままでいい。<br><br>その反応が、<br>あなたの時間の鍵だ。</p>
  <p class="narr narr-dim" style="margin-bottom:1rem">さっきの続き、やりたくなる？</p>
  <div class="resume-btns">
    <button class="resume-btn" onclick="mg3Resume(true)">やりたい</button>
    <button class="resume-btn" onclick="mg3Resume(false)">別にいい</button>
  </div>
  <div class="spacer"></div>
</div>

<div class="scr" id="s-mg3resume">
  <div class="scene-label">あと2秒だけ</div>
  <div class="mg-area" id="mg3r-area">
    <div class="mg-timer" id="mg3r-timer">2.0s</div>
    <div class="num-grid" id="mg3r-grid"></div>
  </div>
</div>

<div class="scr" id="s-mg3end">
  <div class="spacer"></div>
  <p class="narr">記録した。<br>結果を見よう。</p>
  <button class="btn" onclick="showResult()">診断結果を見る</button>
  <div class="spacer"></div>
</div>

<!-- 9. RESULT -->
<div class="scr" id="s-result">
  <div class="scene-label">DIAGNOSIS</div>
  <p class="narr narr-dim" style="margin-bottom:.8rem">あなたは怠けていない。<br>時間が減るのは、設計のクセだ。直せる。</p>
  <div class="res-type" id="r-type"></div>
  <div class="res-title" id="r-title"></div>
  <div class="res-oneliner" id="r-one"></div>

  <div class="bar-chart" id="r-bars"></div>

  <div class="res-card">
    <div class="res-card-label">構造</div>
    <div class="res-card-body" id="r-desc"></div>
  </div>
  <div class="res-card">
    <div class="res-card-label">処方（2つだけ）</div>
    <div class="res-card-body"><ul id="r-rx"></ul></div>
  </div>
  <div class="res-card res-taboo">
    <div class="res-card-label">禁忌（やらないこと）</div>
    <div class="res-card-body" id="r-taboo"></div>
  </div>

  <div class="res-footer">
    <p>構造を知れたことが、<br>すでに調整の始まりだ。</p>
  </div>

  <div class="res-actions">
    <button class="btn" onclick="copyResult()">結果をコピーする</button>
    <button class="btn btn-sm" onclick="location.reload()">もう一度診断</button>
  </div>
</div>

<script>
/* ========== STATE ========== */
const A = {};
const MG = { ts:{}, ps:{}, iw:{} };
const answered = new Set();

/* ========== NAV ========== */
function go(id) {
  document.querySelectorAll('.scr').forEach(s => s.classList.remove('on'));
  document.getElementById(id).classList.add('on');
  window.scrollTo({ top: 0 });
  updateProg(id);
}
const progMap = {
  's-start':0,'s-intro':5,'s-q12':12,'s-mg1':22,'s-mg1done':30,
  's-q34':38,'s-mg2':48,'s-mg2done':55,'s-q56':62,'s-mg3':72,
  's-mg3stop':80,'s-mg3resume':85,'s-mg3end':90,'s-result':100
};
function updateProg(id) {
  document.getElementById('prog').style.width = (progMap[id] || 0) + '%';
}

/* ========== QUESTIONS ========== */
function ans(q, v, el) {
  A[q] = v;
  el.parentElement.querySelectorAll('.q-opt').forEach(o => o.classList.remove('sel'));
  el.classList.add('sel');
  answered.add(q);
  if (q <= 2) enableBtn([1,2], 'btn-q12');
  else if (q <= 4) enableBtn([3,4], 'btn-q34');
  else enableBtn([5,6], 'btn-q56');
}
function enableBtn(qs, btnId) {
  if (qs.every(q => answered.has(q))) {
    document.getElementById(btnId).classList.remove('disabled');
  }
}
// Disable click on .disabled
document.addEventListener('click', e => {
  if (e.target.classList.contains('disabled')) { e.preventDefault(); e.stopPropagation(); }
}, true);

/* ========== MG1: 5秒タップ ========== */
let mg1State = 'idle', mg1StartTime;
function mg1Tap() {
  const c = document.getElementById('mg1-circle');
  if (mg1State === 'idle') {
    mg1State = 'running';
    mg1StartTime = performance.now();
    c.textContent = '…';
    c.classList.add('running');
    document.getElementById('mg1-inst').textContent = '5秒だと思ったらタップ';
  } else if (mg1State === 'running') {
    const t = (performance.now() - mg1StartTime) / 1000;
    const error = t - 5.0;
    const abs_error = Math.abs(error);
    const score = abs_error <= 0.6 ? 0 : abs_error <= 1.5 ? 1 : 2;
    const bias = error < -0.6 ? 'fast' : error > 0.6 ? 'slow' : 'stable';
    MG.ts = { t: +t.toFixed(2), error: +error.toFixed(2), abs_error: +abs_error.toFixed(2), score, bias };
    c.classList.remove('running');
    c.textContent = t.toFixed(1) + '秒';
    c.style.borderColor = 'var(--gold)';
    mg1State = 'done';
    setTimeout(() => go('s-mg1done'), 1200);
  }
}

/* ========== MG2: 瞬間優先度 ========== */
const snapPairs = [
  { a:'企画の骨組みを作る', b:'メールの整理をする' },
  { a:'見積もりを書き上げる', b:'デスク周りを片付ける' },
  { a:'構成案を決める', b:'細かい修正を直す' },
  { a:'核心の連絡を送る', b:'フォルダを整理する' },
  { a:'重要な判断を下す', b:'既読の返信をする' },
];
let mg2Round, mg2A, mg2B, mg2No, mg2Times, mg2Timer, mg2RoundStart, mg2Active;

function mg2Start() {
  document.getElementById('mg2-startbtn').style.display = 'none';
  mg2Round = 0; mg2A = 0; mg2B = 0; mg2No = 0; mg2Times = []; mg2Active = false;
  mg2NextRound();
}
function mg2NextRound() {
  if (mg2Round >= 5) { mg2Finish(); return; }
  mg2Active = true;
  const pair = snapPairs[mg2Round];
  const pairEl = document.getElementById('mg2-pair');
  const barWrap = document.getElementById('mg2-bar-wrap');
  const bar = document.getElementById('mg2-bar');
  document.getElementById('mg2-round').textContent = (mg2Round + 1) + ' / 5';
  pairEl.style.display = 'flex';
  barWrap.style.display = 'block';
  // Reset bar
  bar.style.transition = 'none';
  bar.style.width = '100%';
  void bar.offsetWidth;
  bar.style.transition = 'width 0.7s linear';
  bar.style.width = '0%';

  pairEl.innerHTML =
    `<div class="snap-card" onclick="mg2Pick('A')">${pair.a}</div>` +
    `<div class="snap-card" onclick="mg2Pick('B')">${pair.b}</div>`;
  mg2RoundStart = performance.now();
  mg2Timer = setTimeout(() => mg2Pick('none'), 700);
}
function mg2Pick(choice) {
  if (!mg2Active) return;
  mg2Active = false;
  clearTimeout(mg2Timer);
  mg2Times.push(performance.now() - mg2RoundStart);
  if (choice === 'A') mg2A++;
  else if (choice === 'B') mg2B++;
  else mg2No++;
  mg2Round++;
  setTimeout(mg2NextRound, 300);
}
function mg2Finish() {
  const avg = mg2Times.reduce((a,b)=>a+b,0)/mg2Times.length;
  MG.ps = {
    A: mg2A, B: mg2B, noChoice: mg2No,
    avg_ms: +avg.toFixed(0),
    avoidScore: mg2A >= 3 ? 0 : mg2B >= 3 ? 2 : 1,
    indecisionPenalty: mg2No >= 2 ? 1 : 0
  };
  setTimeout(() => go('s-mg2done'), 600);
}

/* ========== MG3: 強制中断 ========== */
let mg3Next, mg3Progress, mg3Interval, mg3Timeout, mg3CellData;
let mg3ResumeProgress;

function mg3Start() {
  document.getElementById('mg3-startbtn').style.display = 'none';
  mg3Next = 1; mg3Progress = 0;
  const nums = Array.from({length:12},(_,i)=>i+1);
  shuffle(nums);
  mg3CellData = nums;
  const grid = document.getElementById('mg3-grid');
  grid.innerHTML = '';
  nums.forEach(n => {
    const d = document.createElement('div');
    d.className = 'num-cell';
    d.textContent = n;
    d.dataset.n = n;
    d.onclick = () => mg3Tap(n, d);
    grid.appendChild(d);
  });
  let rem = 8.0;
  const tEl = document.getElementById('mg3-timer');
  mg3Interval = setInterval(() => {
    rem -= 0.1; if (rem < 0) rem = 0;
    tEl.textContent = rem.toFixed(1) + 's';
  }, 100);
  mg3Timeout = setTimeout(mg3ForceStop, 8000);
}
function mg3Tap(n, el) {
  if (n === mg3Next) {
    el.classList.add('done');
    mg3Next++; mg3Progress++;
  } else {
    el.classList.add('wrong');
    setTimeout(() => el.classList.remove('wrong'), 300);
  }
}
function mg3ForceStop() {
  clearInterval(mg3Interval);
  clearTimeout(mg3Timeout);
  MG.iw = { progress: mg3Progress, wantResume: null, resumeSpeed: 0 };
  go('s-mg3stop');
}
function mg3Resume(want) {
  MG.iw.wantResume = want;
  if (want) {
    mg3ResumeProgress = 0;
    const grid = document.getElementById('mg3r-grid');
    grid.innerHTML = '';
    const srcGrid = document.getElementById('mg3-grid');
    const srcCells = srcGrid.querySelectorAll('.num-cell');
    srcCells.forEach(sc => {
      const d = document.createElement('div');
      const n = parseInt(sc.dataset.n);
      d.className = 'num-cell' + (n < mg3Next ? ' done' : '');
      d.textContent = sc.textContent;
      d.dataset.n = n;
      d.onclick = () => {
        if (n === mg3Next) {
          d.classList.add('done');
          mg3Next++; mg3ResumeProgress++;
          MG.iw.resumeSpeed = mg3ResumeProgress;
        } else {
          d.classList.add('wrong');
          setTimeout(() => d.classList.remove('wrong'), 300);
        }
      };
      grid.appendChild(d);
    });
    go('s-mg3resume');
    let rem = 2.0;
    const tEl = document.getElementById('mg3r-timer');
    const iv = setInterval(() => {
      rem -= 0.1; if (rem < 0) rem = 0;
      tEl.textContent = rem.toFixed(1) + 's';
    }, 100);
    setTimeout(() => {
      clearInterval(iv);
      MG.iw.progress = mg3Progress + mg3ResumeProgress;
      go('s-mg3end');
    }, 2000);
  } else {
    go('s-mg3end');
  }
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

/* ========== SCORING ========== */
const TYPES = {
  A: {
    name:'分散注意型', title:'注意分断領域の統治者',
    one:'切り替えが多いほど、時間は溶ける。',
    desc:'あなたの時間を削っているのは、作業量ではなく"切り替えコスト"だ。1つを終える前に別へ飛ぶたび、脳のキャッシュが消える。',
    rx:['マルチタスクをやめる ─ 今日だけ「同時進行ゼロ」。やることは1つだけ画面に出す。',
        'ナッジで誘惑ハードルUP ─ スマホは手の届かない場所。通知は1時間だけ封印。'],
    taboo:'いきなり全部改善しない。まず"切り替え"だけ止めろ。',
    rxIds:['H10','H5']
  },
  B: {
    name:'回避最適化型', title:'逃げ道を美しく整える王',
    one:'安心を買う作業が増えると、本丸が消える。',
    desc:'あなたはサボっていない。むしろ働いている。ただ、重要が重いとき、脳は"軽い達成感"で自分を守る。',
    rx:['仕事が早い自分を演じる ─ 「いまの役割：最初の一撃を入れる人」と声に出して開始。',
        '小タスク後回し ─ 5分以内×3個まで先にOK。それ以上は"逃げ道"なので後で。'],
    taboo:'モチベを上げようとしない。開始だけで勝ち。',
    rxIds:['H2','H6']
  },
  C: {
    name:'過密設計型', title:'余白を失った王国の支配者',
    one:'予定が詰まるほど、未来が狭くなる。',
    desc:'時間が足りないのではない。余白がゼロなだけだ。回復がないと、判断力が落ちて、さらに時間が溶ける。',
    rx:['スケジュール8割まで ─ 週に1日、2割を"何もしない枠"として確保。',
        '締切30分前倒し ─ 完成度8割で止める。内容で区切る。'],
    taboo:'"根性で埋める"をやめろ。空白こそ生産だ。',
    rxIds:['H3','H8']
  },
  D: {
    name:'視野狭窄型', title:'縮む時間の結界術師',
    one:'体が緊張すると、時間は縮む。',
    desc:'あなたの問題はタスクではない。身体反応だ。視野が狭まると、世界が小さく感じて時間が足りなくなる。',
    rx:['狭い空間から脱出 ─ 30秒、遠くを見る＋深呼吸。首と肩を回す。',
        '仕組み化 ─ 開始を軽くする：最初の一手を"1クリック"にする。'],
    taboo:'自分を責めるな。体を先に戻せ。思考は後でいい。',
    rxIds:['H1','H4']
  }
};

function showResult() {
  const ts = MG.ts, ps = MG.ps, iw = MG.iw;
  const resumeScore = !iw.wantResume ? 2 : iw.progress >= 5 ? 0 : 1;

  const sub = {
    SpaceNarrow: (A[1]||0) + ts.score,
    Overpacked:  (A[2]||0) + ps.indecisionPenalty + (ts.score >= 1 ? 1 : 0),
    Avoidance:   (A[5]||0) + ps.avoidScore,
    Distraction: (A[4]||0) + (A[6]||0) + resumeScore,
  };

  const maxVal = Math.max(...Object.values(sub));
  const priority = ['Distraction','Avoidance','Overpacked','SpaceNarrow'];
  const keyToType = { Distraction:'A', Avoidance:'B', Overpacked:'C', SpaceNarrow:'D' };
  let type = 'A';
  for (const p of priority) {
    if (sub[p] === maxVal) { type = keyToType[p]; break; }
  }

  const t = TYPES[type];
  document.getElementById('r-type').textContent = t.name;
  document.getElementById('r-title').textContent = '『' + t.title + '』';
  document.getElementById('r-one').textContent = t.one;
  document.getElementById('r-desc').textContent = t.desc;
  document.getElementById('r-rx').innerHTML = t.rx.map(r => '<li>' + r + '</li>').join('');
  document.getElementById('r-taboo').textContent = t.taboo;

  // Bar chart
  const safeMax = Math.max(maxVal, 1);
  const labels = { SpaceNarrow:'視野狭窄', Overpacked:'過密', Avoidance:'回避', Distraction:'分散注意' };
  const typeKey = { A:'Distraction', B:'Avoidance', C:'Overpacked', D:'SpaceNarrow' };
  const barsEl = document.getElementById('r-bars');
  barsEl.innerHTML = '';
  for (const [k, v] of Object.entries(sub)) {
    const pct = Math.round((v / safeMax) * 100);
    const isTop = k === typeKey[type];
    barsEl.innerHTML += `<div class="bar-row">
      <div class="bar-label">${labels[k]}</div>
      <div class="bar-track"><div class="bar-fill ${isTop?'top':'normal'}" style="width:${pct}%"></div></div>
    </div>`;
  }

  window._resultType = type;
  go('s-result');
}

function copyResult() {
  const t = TYPES[window._resultType];
  const text = `【主観時間増幅診断】\n私のタイプ：${t.name}（${t.title}）\n今日の処方：${t.rxIds.join(' / ')}\n禁忌：${t.taboo}`;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(showToast).catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}
function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px';
  document.body.appendChild(ta); ta.select();
  try { document.execCommand('copy'); showToast(); } catch(e) { prompt('結果：', text); }
  document.body.removeChild(ta);
}
function showToast() {
  const t = document.getElementById('toast');
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

/* CSS for disabled button */
document.head.insertAdjacentHTML('beforeend',
  '<style>.btn.disabled{opacity:.3;pointer-events:none}</style>');
</script>
</body>
</html>
